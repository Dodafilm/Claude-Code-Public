<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Austin Rec Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: #1a1a2e;
      color: #eee;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: #16213e;
      border-bottom: 2px solid #0f3460;
      z-index: 1000;
      flex-wrap: wrap;
      gap: 8px;
    }

    header h1 { font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; }
    header h1 span { color: #e94560; }

    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn {
      padding: 6px 14px; border: none; border-radius: 6px; cursor: pointer;
      font-size: 0.85rem; font-weight: 600; transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: #0f3460; color: #eee; }
    .btn-danger  { background: #e94560; color: #fff; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    #map { flex: 1; z-index: 1; }

    /* Legend / Filter Panel */
    .legend {
      position: absolute; bottom: 30px; left: 12px;
      background: rgba(22, 33, 62, 0.95); border-radius: 10px;
      padding: 12px 16px; z-index: 1000; border: 1px solid #0f3460;
      max-width: 220px; max-height: 70vh; overflow-y: auto;
    }
    .legend h3 {
      font-size: 0.75rem; margin-bottom: 8px; color: #aaa;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .legend-item {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 5px; font-size: 0.82rem; cursor: pointer;
      user-select: none; transition: opacity 0.2s;
    }
    .legend-item.disabled { opacity: 0.35; }
    .legend-dot {
      width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0;
      border: 2px solid rgba(255,255,255,0.3);
    }

    /* Modal */
    .modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      z-index: 2000; justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      background: #16213e; border-radius: 14px; padding: 28px;
      width: 380px; max-width: 90vw; border: 1px solid #0f3460;
      max-height: 90vh; overflow-y: auto;
    }
    .modal h2 { margin-bottom: 18px; font-size: 1.1rem; }

    .modal label {
      display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 4px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .modal input, .modal textarea {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid #0f3460; background: #1a1a2e; color: #eee;
      font-size: 0.95rem; margin-bottom: 14px; font-family: inherit;
    }
    .modal textarea { resize: vertical; min-height: 60px; }

    .modal .hint {
      font-size: 0.72rem; color: #666; margin-top: -10px; margin-bottom: 14px;
    }

    .category-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 6px; margin-bottom: 14px;
    }
    .category-btn {
      padding: 8px 4px; border-radius: 8px; border: 2px solid transparent;
      cursor: pointer; font-size: 0.72rem; font-weight: 600;
      text-align: center; transition: all 0.15s; color: #fff;
    }
    .category-btn:hover { filter: brightness(1.15); }
    .category-btn.selected { border-color: #fff; transform: scale(1.04); }

    .modal-actions { display: flex; gap: 10px; margin-top: 6px; }
    .modal-actions .btn { flex: 1; padding: 10px; font-size: 0.95rem; }

    .btn-save { background: #e94560; color: #fff; }
    .btn-cancel { background: #0f3460; color: #eee; }
    .btn-delete { background: #6b2131; color: #fff; }

    .leaflet-tooltip {
      background: #16213e; color: #eee; border: 1px solid #0f3460;
      border-radius: 6px; padding: 6px 12px; font-size: 0.85rem;
      max-width: 260px; white-space: normal;
    }
    .leaflet-tooltip-top::before { border-top-color: #0f3460; }

    .toast {
      position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
      background: rgba(22, 33, 62, 0.95); border: 1px solid #0f3460;
      border-radius: 10px; padding: 10px 20px; z-index: 1000;
      font-size: 0.9rem; color: #ccc; pointer-events: none; transition: opacity 0.5s;
    }

    #import-file { display: none; }

    .search-box {
      position: absolute; top: 62px; right: 12px; z-index: 1000;
    }
    .search-box input {
      padding: 8px 14px; border-radius: 8px; border: 1px solid #0f3460;
      background: rgba(22,33,62,0.95); color: #eee; font-size: 0.9rem;
      width: 220px; font-family: inherit;
    }
    .search-box input::placeholder { color: #666; }
  </style>
</head>
<body>
  <header>
    <h1><span>Austin</span> Rec Map</h1>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openAddByAddress()">+ Add by Address</button>
      <button class="btn btn-primary" onclick="document.getElementById('import-file').click()">Import CSV</button>
      <input type="file" id="import-file" accept=".csv,.json" />
      <button class="btn btn-primary" onclick="exportCSV()">Export CSV</button>
      <button class="btn btn-danger" onclick="resetToFile()">Reload CSV</button>
    </div>
  </header>

  <div id="map"></div>
  <div class="search-box"><input type="text" id="search" placeholder="Search pins..." /></div>
  <div class="legend" id="legend"></div>
  <div class="toast" id="toast">Click anywhere on the map to add a pin — or use + Add by Address</div>

  <!-- Add Modal -->
  <div class="modal-overlay" id="add-modal">
    <div class="modal">
      <h2>Add Recommendation</h2>
      <label>Name</label>
      <input type="text" id="rec-name" placeholder="e.g. Barton Springs Pool" />
      <label>Address</label>
      <input type="text" id="rec-address" placeholder="e.g. 1619 E 6th St, Austin, TX" />
      <p class="hint" id="add-location-hint"></p>
      <label>Category</label>
      <div class="category-grid" id="category-grid"></div>
      <label>Notes</label>
      <textarea id="rec-notes" placeholder="What makes it great?"></textarea>
      <div class="modal-actions">
        <button class="btn btn-cancel" onclick="closeModal('add-modal')">Cancel</button>
        <button class="btn btn-save" id="add-save-btn" onclick="saveMarker()">Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="edit-modal">
    <div class="modal">
      <h2>Edit Recommendation</h2>
      <label>Name</label>
      <input type="text" id="edit-name" />
      <label>Address</label>
      <input type="text" id="edit-address" placeholder="Address" />
      <p class="hint">Changing the address will update the pin's position.</p>
      <label>Category</label>
      <div class="category-grid" id="edit-category-grid"></div>
      <label>Notes</label>
      <textarea id="edit-notes"></textarea>
      <div class="modal-actions">
        <button class="btn btn-delete" onclick="deleteMarker()">Delete</button>
        <button class="btn btn-cancel" onclick="closeModal('edit-modal')">Cancel</button>
        <button class="btn btn-save" id="edit-save-btn" onclick="updateMarker()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // ── Categories ──
    const CATEGORIES = [
      { id: 'neighborhood', label: 'Neighborhoods',      color: '#94a3b8' },
      { id: 'coffee',       label: 'Coffee',             color: '#d97706' },
      { id: 'food',         label: 'Food',               color: '#e94560' },
      { id: 'drinks',       label: 'Bars & Nightlife',   color: '#f5a623' },
      { id: 'music',        label: 'Live Music',         color: '#a855f7' },
      { id: 'festival',     label: 'Festivals & Events', color: '#fbbf24' },
      { id: 'arts',         label: 'Arts & Culture',     color: '#f472b6' },
      { id: 'shopping',     label: 'Shopping & Records', color: '#ec4899' },
      { id: 'outdoors',     label: 'Outdoors & Nature',  color: '#4ecdc4' },
      { id: 'entertainment',label: 'Entertainment',      color: '#3b82f6' },
      { id: 'fitness',      label: 'Health & Wellness',  color: '#22c55e' },
      { id: 'daytrip',      label: 'Day Trips',          color: '#06b6d4' },
    ];

    // ── State ──
    let recommendations = [];
    let pendingLatLng = null;
    let selectedCategory = null;
    let editingId = null;
    let editCategory = null;
    let markerLayer = L.layerGroup();
    let hiddenCategories = new Set(JSON.parse(localStorage.getItem('austin-recs-hidden') || '[]'));
    let searchQuery = '';

    // ── Geocoding via Nominatim (OpenStreetMap) ──
    const geocodeCache = JSON.parse(localStorage.getItem('austin-recs-geocache') || '{}');

    async function geocodeAddress(address) {
      if (!address) return null;
      if (geocodeCache[address]) return geocodeCache[address];
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
      try {
        const resp = await fetch(url, {
          headers: { 'User-Agent': 'AustinRecMap/1.0' }
        });
        const data = await resp.json();
        if (data.length > 0) {
          const result = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
          geocodeCache[address] = result;
          localStorage.setItem('austin-recs-geocache', JSON.stringify(geocodeCache));
          return result;
        }
      } catch (e) { console.warn('Geocoding failed for:', address, e); }
      return null;
    }

    async function geocodeMissing(recs) {
      const toGeocode = recs.filter(r => r.address && (isNaN(r.lat) || isNaN(r.lng)));
      if (toGeocode.length === 0) return;
      showToastMsg(`Geocoding ${toGeocode.length} address${toGeocode.length > 1 ? 'es' : ''}...`, toGeocode.length * 1200 + 2000);
      for (let i = 0; i < toGeocode.length; i++) {
        const rec = toGeocode[i];
        const result = await geocodeAddress(rec.address);
        if (result) {
          rec.lat = result.lat;
          rec.lng = result.lng;
        }
        if (i < toGeocode.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 1100)); // Nominatim rate limit: 1 req/sec
        }
      }
      save();
      renderMarkers();
      showToastMsg('Geocoding complete!');
    }

    // ── CSV Parsing ──
    function parseCSVText(text) {
      const result = Papa.parse(text.trim(), {
        header: true,
        skipEmptyLines: true,
        dynamicTyping: false,
      });
      return result.data.map(row => ({
        id: (row.id || '').trim(),
        name: (row.name || '').trim(),
        category: (row.category || '').trim(),
        address: (row.address || '').trim(),
        lat: parseFloat(row.lat),
        lng: parseFloat(row.lng),
        notes: (row.notes || '').trim(),
      })).filter(r => r.name && ((!isNaN(r.lat) && !isNaN(r.lng)) || r.address));
    }

    function toCSVText(data) {
      return Papa.unparse(data.map(r => ({
        id: r.id,
        name: r.name,
        category: r.category,
        address: r.address || '',
        lat: r.lat,
        lng: r.lng,
        notes: r.notes || '',
      })), { columns: ['id','name','category','address','lat','lng','notes'] });
    }

    // ── Load data: localStorage first, then fetch data.csv ──
    async function loadData() {
      const cached = localStorage.getItem('austin-recs-v3');
      if (cached) {
        recommendations = JSON.parse(cached);
        renderMarkers();
        return;
      }
      await loadFromCSVFile();
    }

    async function loadFromCSVFile() {
      try {
        const resp = await fetch('data.csv?t=' + Date.now());
        if (!resp.ok) throw new Error('No CSV found');
        const text = await resp.text();
        recommendations = parseCSVText(text);
        save();
        renderMarkers();
        // Geocode entries that have address but missing coordinates
        await geocodeMissing(recommendations);
      } catch (e) {
        console.warn('Could not load data.csv:', e);
        recommendations = [];
        renderMarkers();
      }
    }

    // ── Persistence ──
    function save() {
      localStorage.setItem('austin-recs-v3', JSON.stringify(recommendations));
    }

    // ── Map ──
    const map = L.map('map', { center: [30.2672, -97.7431], zoom: 13, zoomControl: false });
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19,
    }).addTo(map);
    markerLayer.addTo(map);

    // ── Toast ──
    function showToastMsg(msg, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.opacity = '1';
      clearTimeout(toast._timeout);
      toast._timeout = setTimeout(() => { toast.style.opacity = '0'; }, duration);
    }

    // ── Legend with toggles (only shows categories that have data) ──
    function buildLegend() {
      const activeCats = new Set(recommendations.map(r => r.category));
      const el = document.getElementById('legend');
      el.innerHTML = '<h3>Filter Categories</h3>' + CATEGORIES.filter(c => activeCats.has(c.id)).map(c => {
        const disabled = hiddenCategories.has(c.id) ? ' disabled' : '';
        return `<div class="legend-item${disabled}" data-cat="${c.id}" onclick="toggleCategory('${c.id}')">
          <div class="legend-dot" style="background:${c.color}"></div>
          ${c.label}
        </div>`;
      }).join('');
    }

    function toggleCategory(id) {
      if (hiddenCategories.has(id)) hiddenCategories.delete(id);
      else hiddenCategories.add(id);
      localStorage.setItem('austin-recs-hidden', JSON.stringify([...hiddenCategories]));
      buildLegend();
      renderMarkers();
    }

    // ── Category Buttons ──
    function buildCategoryButtons(containerId, onSelect) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      CATEGORIES.forEach(c => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'category-btn';
        btn.style.background = c.color;
        btn.textContent = c.label;
        btn.dataset.id = c.id;
        btn.addEventListener('click', () => {
          container.querySelectorAll('.category-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          onSelect(c.id);
        });
        container.appendChild(btn);
      });
    }
    buildCategoryButtons('category-grid', id => { selectedCategory = id; });
    buildCategoryButtons('edit-category-grid', id => { editCategory = id; });

    // ── Render Markers ──
    function renderMarkers() {
      markerLayer.clearLayers();
      buildLegend();
      const q = searchQuery.toLowerCase();
      recommendations.forEach(rec => {
        // Skip entries without valid coordinates (pending geocoding)
        if (isNaN(rec.lat) || isNaN(rec.lng)) return;
        if (hiddenCategories.has(rec.category)) return;
        if (q && !rec.name.toLowerCase().includes(q)
            && !(rec.notes || '').toLowerCase().includes(q)
            && !(rec.address || '').toLowerCase().includes(q)) return;

        const cat = CATEGORIES.find(c => c.id === rec.category) || CATEGORIES[0];
        const isNeighborhood = rec.category === 'neighborhood';
        const marker = L.circleMarker([rec.lat, rec.lng], {
          radius: isNeighborhood ? 14 : 9,
          fillColor: cat.color,
          color: isNeighborhood ? cat.color : 'rgba(255,255,255,0.5)',
          weight: isNeighborhood ? 2 : 3,
          fillOpacity: isNeighborhood ? 0.25 : 0.9,
        });

        let tooltipContent = `<strong>${rec.name}</strong><br><em>${cat.label}</em>`;
        if (rec.address) tooltipContent += `<br><small>${rec.address}</small>`;
        if (rec.notes) tooltipContent += `<br>${rec.notes}`;
        marker.bindTooltip(tooltipContent, { direction: 'top', offset: [0, -8] });
        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); openEditModal(rec.id); });
        markerLayer.addLayer(marker);
      });
    }

    // ── Search (also searches addresses) ──
    document.getElementById('search').addEventListener('input', (e) => {
      searchQuery = e.target.value.trim();
      renderMarkers();
    });

    // ── Map Click → Add ──
    map.on('click', (e) => {
      pendingLatLng = e.latlng;
      selectedCategory = null;
      document.getElementById('rec-name').value = '';
      document.getElementById('rec-address').value = '';
      document.getElementById('rec-notes').value = '';
      document.getElementById('add-location-hint').textContent = 'Pin placed at clicked location. Address is optional (for display).';
      document.querySelectorAll('#category-grid .category-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('add-modal').classList.add('active');
      setTimeout(() => document.getElementById('rec-name').focus(), 100);
    });

    // ── Add by Address (no map click) ──
    function openAddByAddress() {
      pendingLatLng = null;
      selectedCategory = null;
      document.getElementById('rec-name').value = '';
      document.getElementById('rec-address').value = '';
      document.getElementById('rec-notes').value = '';
      document.getElementById('add-location-hint').textContent = 'Address will be geocoded to place the pin on the map.';
      document.querySelectorAll('#category-grid .category-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('add-modal').classList.add('active');
      setTimeout(() => document.getElementById('rec-address').focus(), 100);
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
      if (id === 'add-modal') pendingLatLng = null;
      if (id === 'edit-modal') editingId = null;
    }

    async function saveMarker() {
      const name = document.getElementById('rec-name').value.trim();
      const address = document.getElementById('rec-address').value.trim();
      if (!name) { alert('Please enter a name.'); return; }
      if (!selectedCategory) { alert('Please pick a category.'); return; }

      let lat, lng;
      if (pendingLatLng) {
        // Map click — use clicked coordinates
        lat = pendingLatLng.lat;
        lng = pendingLatLng.lng;
      } else if (address) {
        // No map click — geocode the address
        const btn = document.getElementById('add-save-btn');
        btn.textContent = 'Geocoding...';
        btn.disabled = true;
        const result = await geocodeAddress(address);
        btn.textContent = 'Save';
        btn.disabled = false;
        if (!result) {
          alert('Could not geocode that address. Try a more specific address, or add the pin by clicking the map.');
          return;
        }
        lat = result.lat;
        lng = result.lng;
      } else {
        alert('Please enter an address, or close this and click the map to place a pin.');
        return;
      }

      recommendations.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
        name, category: selectedCategory, address,
        notes: document.getElementById('rec-notes').value.trim(),
        lat, lng,
      });
      save(); renderMarkers(); closeModal('add-modal');
    }

    // ── Edit ──
    function openEditModal(id) {
      const rec = recommendations.find(r => r.id === id);
      if (!rec) return;
      editingId = id;
      editCategory = rec.category;
      document.getElementById('edit-name').value = rec.name;
      document.getElementById('edit-address').value = rec.address || '';
      document.getElementById('edit-notes').value = rec.notes || '';
      document.querySelectorAll('#edit-category-grid .category-btn').forEach(b => {
        b.classList.toggle('selected', b.dataset.id === rec.category);
      });
      document.getElementById('edit-modal').classList.add('active');
    }

    async function updateMarker() {
      const rec = recommendations.find(r => r.id === editingId);
      if (!rec) return;
      const name = document.getElementById('edit-name').value.trim();
      const address = document.getElementById('edit-address').value.trim();
      if (!name) { alert('Please enter a name.'); return; }
      if (!editCategory) { alert('Please pick a category.'); return; }

      // Re-geocode if address changed
      if (address && address !== (rec.address || '')) {
        const btn = document.getElementById('edit-save-btn');
        btn.textContent = 'Geocoding...';
        btn.disabled = true;
        const result = await geocodeAddress(address);
        btn.textContent = 'Save';
        btn.disabled = false;
        if (result) {
          rec.lat = result.lat;
          rec.lng = result.lng;
        }
      }

      rec.name = name;
      rec.address = address;
      rec.category = editCategory;
      rec.notes = document.getElementById('edit-notes').value.trim();
      save(); renderMarkers(); closeModal('edit-modal');
    }

    function deleteMarker() {
      if (!confirm('Delete this recommendation?')) return;
      recommendations = recommendations.filter(r => r.id !== editingId);
      save(); renderMarkers(); closeModal('edit-modal');
    }

    // ── Export CSV ──
    function exportCSV() {
      const csv = toCSVText(recommendations);
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'data.csv';
      a.click();
    }

    // ── Import CSV ──
    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const text = ev.target.result;
          if (file.name.endsWith('.json')) {
            const data = JSON.parse(text);
            if (Array.isArray(data)) recommendations = data;
          } else {
            recommendations = parseCSVText(text);
          }
          save(); renderMarkers();
          // Geocode any imported entries missing coordinates
          await geocodeMissing(recommendations);
        } catch { alert('Could not parse file.'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // ── Reload from data.csv (discard local edits) ──
    function resetToFile() {
      if (!confirm('Reload from data.csv? This will discard any pins you added in the browser.')) return;
      localStorage.removeItem('austin-recs-v3');
      loadFromCSVFile();
    }

    // ── Keyboard ──
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeModal('add-modal'); closeModal('edit-modal'); }
    });

    // ── Toast ──
    setTimeout(() => { document.getElementById('toast').style.opacity = '0'; }, 5000);

    // ── Init ──
    loadData();
  </script>
</body>
</html>
